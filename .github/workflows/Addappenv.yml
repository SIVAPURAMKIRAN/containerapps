name: newcontinerapp

on:
  push:
    branches: [ "environmentcreate" ]
  

jobs:
  build:

    runs-on: ubuntu-latest
    continue-on-error: false
    env:
        rootempfoldername: ${{ vars.rootempfoldername }}
    container: 
      image: kirankumarsivapuram/base_image:3.0             

    steps:
    - uses: actions/checkout@v3           
    - name: az login
      run: |
        az login --service-principal -u ${{secrets.user1}} -p ${{secrets.password1}} -t ${{secrets.azure_tenent_id}} 
        echo  ${{ vars.rootempfoldername }}
    
    - name: set subscription
      run: az account set --subscription ${{secrets.azure_subscription_id}}    
    - name: create container app
      shell: pwsh
      run: |
        [int]$MinReplica = 0
        [int]$MaxReplica = 30
        $ContainerRegistry = "${{ vars.ACRNAME }}"
        #$RegistryPassword = "CSvdDR/VJRki0dWgukZ4r0TKVSx/lt+AxjZE7sDM22+ACRCxxwgp"
        $ImageURL="acrtestpoc.azurecr.io/policyapi:6296055397"
        write-output "Image url is : $ImageURL"
        $Appname = "${{ vars.appname }}"
        $ResourceGroupName = "${{ vars.CONTAINERAPPRGNAME }}"
        $AppEnvironmentName = "${{ vars.CONTAINERAPPENVNAME }}"
        $Ingress = "${{ vars.ingress }}"
        $IngressPort = "${{ vars.ingressport }}"
        $Registryserver = "$ContainerRegistry.azurecr.io"
        $AppCpu = "${{ vars.APPCPU }}"
        $AppMemory = "${{ vars.APPMEMORY }}"
        $ScaleRuleHTTPName = "${{ vars.ScaleRuleName }}"
        $ScaleRuleType = "${{ vars.ScaleRuleType }}"
        $ScalRuleconcurrency = "${{ vars.ScalRuleconcurrency }}"
        
        write-output $Appname
        write-output $ResourceGroupName
        write-output $AppEnvironmentName
        az containerapp create -n $Appname -g $ResourceGroupName --image $ImageURL --environment $AppEnvironmentName --ingress $Ingress --target-port $IngressPort --registry-server $Registryserver --registry-username ${{secrets.ACRPUSHUSER}} --registry-password ${{secrets.ACRPUSHPASSWORD}} --query properties.configuration.ingress.fqdn --cpu $AppCpu --memory $AppMemory --min-replicas $MinReplica --max-replicas $MaxReplica --scale-rule-name $ScaleRuleHTTPName --scale-rule-type $ScaleRuleType  --scale-rule-http-concurrency $ScalRuleconcurrency
        #az containerapp create -n $Appname -g $ResourceGroupName --image $ImageURL --environment $AppEnvironmentName --ingress external --target-port 80 --registry-server acrtestpoc.azurecr.io --registry-username $ContainerRegistry --registry-password ${{secrets.REGISTRYPASSWORD}} --query properties.configuration.ingress.fqdn --cpu 0.25 --memory 0.5Gi --min-replicas $MinReplica --max-replicas $MaxReplica --scale-rule-name azure-http-rule --scale-rule-type http --scale-rule-http-concurrency 20
        
